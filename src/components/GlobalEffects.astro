---
// src/components/GlobalEffects.astro
---
<div class="cursor-follower"></div>
<div class="noise-overlay"></div>
<div class="global-grid"></div>

<style is:global>
    * {
        cursor: none !important;
    }

    .cursor-follower {
        position: fixed;
        width: 12px;
        height: 12px;
        background-color: #fff;
        border-radius: 50%;
        pointer-events: none;
        z-index: 100000;
        mix-blend-mode: difference;
        transition: width 0.3s, height 0.3s, background-color 0.3s;
    }

    .cursor-follower.hovering {
        width: 60px;
        height: 60px;
        background-color: #fff;
    }

    /* Noise Din√¢mico (Textura de monitor) */
    .noise-overlay {
        position: fixed;
        top: -50%; left: -50%; width: 200%; height: 200%;
        background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 400 400' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.75' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        opacity: 0.05;
        pointer-events: none; 
        z-index: 99999;
        animation: noise-move 0.2s steps(3) infinite;
    }

    @keyframes noise-move {
        0% { transform: translate(0,0) }
        50% { transform: translate(-1%, 1%) }
        100% { transform: translate(1%, -1%) }
    }

    /* Global Engineering Grid */
    .global-grid {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: 
            linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
        background-size: 40px 40px;
        pointer-events: none;
        z-index: -1;
        opacity: 0.5;
    }

    /* Esconder barra de scroll */
    ::-webkit-scrollbar {
        display: none;
    }
    html {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    @media (max-width: 768px) {
        .cursor-follower {
            display: none !important;
        }
        * {
            cursor: auto !important;
        }
    }
</style>

<script>
    import gsap from 'gsap';
    import Lenis from '@studio-freight/lenis';

    // Smooth Scroll
    const lenis = new Lenis();
    function raf(time: number) {
        lenis.raf(time);
        requestAnimationFrame(raf);
    }
    requestAnimationFrame(raf);

    // Make lenis accessible globally for other scripts
    (window as any).lenis = lenis;

    // Cursor Follower
    const cursor = document.querySelector('.cursor-follower') as HTMLElement;
    
    if (cursor) {
        window.addEventListener('mousemove', (e) => {
            gsap.to(cursor, {
                x: e.clientX,
                y: e.clientY,
                xPercent: -50,
                yPercent: -50,
                duration: 0.4,
                ease: "power2.out"
            });
        });

        // Hover effects
        const hoverTags = 'a, button, .htb-card, .photo-placeholder, .nav-button, .htb-view-btn, .htb-archive-btn';
        
        const addHover = () => cursor.classList.add('hovering');
        const removeHover = () => cursor.classList.remove('hovering');

        document.querySelectorAll(hoverTags).forEach(el => {
            el.addEventListener('mouseenter', addHover);
            el.addEventListener('mouseleave', removeHover);
        });

        // Handle dynamic content (like HTB cards loaded via JS or Astro template)
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    if (node instanceof HTMLElement) {
                        const targets = node.querySelectorAll(hoverTags);
                        if (node.matches(hoverTags)) {
                            node.addEventListener('mouseenter', addHover);
                            node.addEventListener('mouseleave', removeHover);
                        }
                        targets.forEach(el => {
                            el.addEventListener('mouseenter', addHover);
                            el.addEventListener('mouseleave', removeHover);
                        });
                    }
                });
            });
        });

        observer.observe(document.body, { childList: true, subtree: true });
    }
</script>
