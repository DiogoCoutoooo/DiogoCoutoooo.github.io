---
interface Props {
	title: string;
	os: string;
	difficulty: string;
	pwnedDate: string;
	avatar: string;
	status?: string;
}

const { title, os, difficulty, pwnedDate, avatar, status = "PWNED" } = Astro.props;
import GlobalEffects from './GlobalEffects.astro';
import { Image } from 'astro:assets';

const difficultyColor: Record<string, string> = {
    Easy:   '#9acd32',
    Medium: '#f39c12',
    Hard:   '#e74c3c',
    Insane: '#ffffff',
};

const diffColor = difficultyColor[difficulty] || '#9acd32';

// Status colors
const statusColors: Record<string, { bg: string, text: string }> = {
    "PWNED":      { bg: "#9acd32", text: "#000" },
    "USER PWNED": { bg: "#f39c12", text: "#000" },
    "NOT PWNED":  { bg: "#3e444d", text: "#fff" }
};

const currentStatus = statusColors[status] || statusColors["PWNED"];
---

<html lang="pt">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width" />
		<title>{title} | HTB Pwned</title>
		<style is:global>
			@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Syne:wght@800&family=Inter:wght@400;700&display=swap');

			body {
				margin: 0;
				background-color: #050505;
				color: #fff;
				font-family: 'JetBrains Mono', monospace;
				line-height: 1.6;
				overflow-x: hidden;
                cursor: none;
			}

			.container {
				max-width: 1300px;
				margin: 0 auto;
				padding: 100px 4vw;
			}

			.back-link {
				color: #9acd32;
				text-decoration: none;
				font-size: 0.8rem;
				text-transform: uppercase;
				letter-spacing: 0.2em;
				margin-bottom: 40px;
				display: inline-block;
				transition: all 0.3s;
			}

			.back-link:hover {
				opacity: 0.7;
				transform: translateX(-5px);
			}

			.machine-header {
				display: flex;
				align-items: center;
				gap: 40px;
				margin-bottom: 60px;
				background: rgba(255, 255, 255, 0.05);
				padding: 50px;
				border: 1px solid rgba(255, 255, 255, 0.12);
                backdrop-filter: blur(12px);
				border-radius: 4px;
                position: relative;
                overflow: hidden;
			}
            
            .machine-header::before {
                content: "";
                position: absolute;
                top: 0; left: 0; width: 4px; height: 100%;
                background: var(--diff-color);
            }

			.avatar {
				width: 140px;
				height: 140px;
				border-radius: 50%;
				border: 2px solid var(--diff-color);
				padding: 6px;
                background: #050505;
                flex-shrink: 0;
			}

			.machine-header h1 {
				font-family: 'Syne', sans-serif;
				font-size: clamp(2.5rem, 8vw, 4.5rem);
				margin: 0;
				line-height: 1;
				text-transform: uppercase;
                word-break: break-all;
			}

			.meta-grid {
				display: flex;
                gap: 60px;
				margin-top: 30px;
				font-size: 0.75rem;
				text-transform: uppercase;
				letter-spacing: 0.2em;
				opacity: 0.8;
			}

			.meta-item b {
				color: var(--diff-color);
				display: block;
				margin-bottom: 8px;
                font-size: 0.65rem;
                opacity: 0.5;
			}

            .header-glitch-top {
                position: absolute;
                top: 15px;
                right: 20px;
                font-size: 0.6rem;
                letter-spacing: 0.3em;
                opacity: 0.3;
                font-family: 'JetBrains Mono', monospace;
            }

            @media (max-width: 900px) {
                .machine-header {
                    flex-direction: column;
                    text-align: center;
                    padding: 60px 20px 40px;
                    gap: 30px;
                }
                .meta-grid {
                    flex-direction: column;
                    gap: 30px;
                    align-items: center;
                }
                .header-glitch-top {
                    left: 0; right: 0;
                    text-align: center;
                    top: 10px;
                }
                .machine-header h1 {
                    font-size: 2.5rem;
                }
            }

			/* Markdown Styling - Scoped to .writeup-content */
			.writeup-content {
				font-size: 1.1rem;
				line-height: 1.8;
                max-width: 850px; /* Optimal reading width */
                margin: 0 auto;
                color: rgba(255, 255, 255, 0.9);
                font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
			}

            .writeup-content > * {
                margin-bottom: 25px;
            }

			.writeup-content h2 {
				font-family: 'Syne', sans-serif;
				font-size: 2rem;
				margin: 60px 0 25px;
				color: #fff;
				text-transform: uppercase;
				border-bottom: 2px solid #9acd32;
				padding-bottom: 10px;
                letter-spacing: -0.01em;
			}

            .writeup-content h3 {
				font-family: 'Syne', sans-serif;
				font-size: 1.3rem;
				margin: 40px 0 15px;
				color: #9acd32;
				text-transform: uppercase;
			}

			.writeup-content p { 
                opacity: 0.9;
                line-height: 1.7;
            }

            .writeup-content a {
                color: #9acd32;
                text-decoration: none;
                border-bottom: 1px solid rgba(154, 205, 50, 0.3);
                transition: border 0.2s;
            }

            .writeup-content a:hover {
                border-bottom-color: #9acd32;
            }

			.writeup-content pre {
				background: #0d1117 !important;
				padding: 24px;
				border-radius: 8px;
				border: 1px solid rgba(255, 255, 255, 0.1);
				margin: 30px 0;
				overflow-x: auto;
                box-shadow: inset 0 1px 10px rgba(0,0,0,0.3);
                transition: max-height 0.4s ease-out;
                
                /* Estilos da Scrollbar */
                scrollbar-width: auto;
                scrollbar-color: #9acd32 rgba(255, 255, 255, 0.05);
			}

            /* Collapsible logic styling */
            .code-block-wrapper {
                position: relative;
                margin: 30px 0;
            }

            .code-block-wrapper.collapsed pre {
                max-height: 350px;
                overflow: hidden;
                padding-bottom: 60px;
            }

            .code-block-wrapper .expand-btn {
                display: none;
                position: absolute;
                bottom: 0;
                left: 0;
                width: 100%;
                background: linear-gradient(transparent, #0d1117 60%, #0d1117);
                color: #9acd32;
                border: none;
                padding: 40px 0 15px;
                cursor: pointer;
                font-family: 'JetBrains Mono', monospace;
                font-size: 0.7rem;
                text-transform: uppercase;
                letter-spacing: 0.2em;
                z-index: 10;
                border-radius: 0 0 8px 8px;
                transition: color 0.2s;
            }

            .code-block-wrapper.collapsed .expand-btn {
                display: block;
            }

            .code-block-wrapper .expand-btn:hover {
                color: #fff;
            }

            .writeup-content pre code {
                font-weight: 400;
                color: #e6edf3;
            }

            /* Scrollbar experimental para Chrome/Edge/Safari */
            .writeup-content pre::-webkit-scrollbar {
                height: 10px;
            }
            .writeup-content pre::-webkit-scrollbar-track {
                background: rgba(255, 255, 255, 0.05);
                border-radius: 0 0 8px 8px;
            }
            .writeup-content pre::-webkit-scrollbar-thumb {
                background: rgba(154, 205, 50, 0.5);
                border-radius: 10px;
                border: 1px solid #0d1117;
            }
            .writeup-content pre:hover::-webkit-scrollbar-thumb {
                background: #9acd32;
            }

			.writeup-content code {
				font-family: 'JetBrains Mono', monospace;
				font-size: 0.9rem;
				color: #e6edf3;
                background: rgba(255, 255, 255, 0.1);
                padding: 3px 6px;
                border-radius: 4px;
                word-break: break-all;
			}

            .writeup-content pre code {
                color: inherit;
                background: none;
                padding: 0;
                white-space: pre; 
                word-break: normal;
                font-size: 0.85rem;
            }

            .writeup-content strong {
                color: #fff;
                font-weight: 700;
            }

            .writeup-content ul, .writeup-content ol {
                padding-left: 25px;
            }

            .writeup-content li {
                margin-bottom: 10px;
            }

            .writeup-content blockquote {
                border-left: 4px solid #30363d;
                padding: 15px 25px;
                color: #8b949e;
                background: rgba(48, 54, 61, 0.1);
                margin: 30px 0;
            }

            .writeup-content img {
                border: 1px solid #30363d;
                max-width: 100%;
				border-radius: 4px;
				margin: 40px 0;
            }

			.status-badge {
				background: var(--status-bg);
				color: var(--status-text);
				padding: 4px 12px;
				font-size: 0.65rem;
				font-weight: 800;
				border-radius: 4px;
				vertical-align: middle;
				margin-left: 15px;
                text-transform: uppercase;
                letter-spacing: 0.1em;
                display: inline-block;
			}
		</style>
	</head>
	<body style={`--diff-color: ${diffColor}; --status-bg: ${currentStatus.bg}; --status-text: ${currentStatus.text};`}>
		<GlobalEffects />
		<main class="container">
			<a href="/htb" class="back-link">← Security_Archive</a>
			
			<header class="machine-header">
                <div class="header-glitch-top">MISSION_REPORT // {title.toUpperCase()}</div>
				<Image src={avatar} alt={title} class="avatar" width={140} height={140} />
				<div>
					<h1>{title} <span class="status-badge">{status}</span></h1>
					<div class="meta-grid">
						<div class="meta-item"><b>Target_OS</b> {os}</div>
						<div class="meta-item"><b>Threat_Level</b> {difficulty}</div>
						<div class="meta-item"><b>Entry_Date</b> {pwnedDate}</div>
					</div>
				</div>
			</header>

			<article class="writeup-content">
				<slot />
			</article>
		</main>

        <script>
            function setupCollapsibleCode() {
                const codeBlocks = document.querySelectorAll('.writeup-content pre');
                const MAX_HEIGHT = 350;

                codeBlocks.forEach(pre => {
                    if (pre.parentElement?.classList.contains('code-block-wrapper')) return;

                    if (pre.scrollHeight > MAX_HEIGHT + 50) {
                        const wrapper = document.createElement('div');
                        wrapper.className = 'code-block-wrapper collapsed';
                        
                        const expandBtn = document.createElement('button');
                        expandBtn.className = 'expand-btn';
                        expandBtn.innerText = '↓ View Full Output [Click to Expand]';
                        
                        pre.parentNode?.insertBefore(wrapper, pre);
                        wrapper.appendChild(pre);
                        wrapper.appendChild(expandBtn);

                        expandBtn.addEventListener('click', () => {
                            const isCollapsed = wrapper.classList.contains('collapsed');
                            if (isCollapsed) {
                                wrapper.classList.remove('collapsed');
                                expandBtn.innerText = '↑ Collapse Output';
                            } else {
                                wrapper.classList.add('collapsed');
                                expandBtn.innerText = '↓ View Full Output [Click to Expand]';
                                wrapper.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                            }
                        });
                    }
                });
            }

            setupCollapsibleCode();
            document.addEventListener('astro:page-load', setupCollapsibleCode);
        </script>
	</body>
</html>
